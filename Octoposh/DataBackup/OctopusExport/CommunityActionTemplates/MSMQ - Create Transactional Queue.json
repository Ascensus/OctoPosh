{
  "$type": "Octopus.Core.Model.Projects.CommunityActionTemplate, Octopus.Core",
  "Id": "CommunityActionTemplates-103",
  "Name": "MSMQ - Create Transactional Queue",
  "ExternalId": "4c22f201-c634-4a22-aa55-ae24dc83d588",
  "Description": "Create one or more MSMQ transactional queues and configure permissions.",
  "Version": 6,
  "ActionType": "Octopus.Script",
  "Author": "RehanSaeed",
  "Website": "https://library.octopus.com/step-templates/4c22f201-c634-4a22-aa55-ae24dc83d588",
  "HistoryUrl": "https://github.com/OctopusDeploy/Library/commits/master/step-templates/msmq-create-transactional-queue.json",
  "Category": "Windows",
  "Properties": {
    "Octopus.Action.Script.ScriptBody": "#Split the Queues into an array\n$arrQueues = $MSMQQueues.split(\";\")\nforeach ($Queue in $arrQueues) \n{\n    #Does Queue Exists Already?\n    $thisQueue = Get-MSMQQueue $Queue\n    if (!$thisQueue)\n    {\n        #not found, create\n        Write-Output \"Creating Queue: \" $Queue\n        New-MsmqQueue -Name \"$Queue\" -Transactional | Out-Null\n        $thisQueue = Get-MSMQQueue $Queue    \n    }\n    else\n    {\n        #keep rolling\n        Write-Output \"Queue Exists: \" $thisQueue.QueueName\n    }\n\n    #set acl for users\n    $arrUsers = $MSMQUsers.split(\";\")\n    foreach ($User in $arrUsers)     \n    {    \n        if ($User)\n        {    \n            Write-Output \"Adding ACL for User: \" $User        \n            \n            #allows\n            if ($MSMQPermAllow)\n            {\n                $arrPermissions = $MSMQPermAllow.split(\";\")\n                foreach ($Permission in $arrPermissions)     \n                {\n                    $thisQueue | Set-MsmqQueueAcl -UserName $User -Allow $Permission | Out-Null                \n                    Write-Output \"ACL Allow set: $Permission\"\n                }\n            }\n                \n            #denies\n            if ($MSMQPermDeny)\n            {\n                $arrPermissions = $MSMQPermDeny.split(\";\")\n                foreach ($Permission in $arrPermissions)     \n                {\n                    $thisQueue | Set-MsmqQueueAcl -UserName $User -Deny $Permission | Out-Null\n                    Write-Output \"ACL Deny set: $Permission\"\n                }\n            }\n        }\n    }   \n    \n    \n    $arrAdminUsers = $MSMQAdminUsers.split(\";\") \n    foreach ($User in $arrAdminUsers)     \n    {    \n        if ($User)\n        { \n            Write-Output \"Adding ACL for Admin User: \" $User        \n            \n            #allows\n            if ($MSMQPermAdminAllow)\n            {\n                $arrPermissions = $MSMQPermAdminAllow.split(\";\")\n                foreach ($Permission in $arrPermissions)     \n                {\n                    $thisQueue | Set-MsmqQueueAcl -UserName $User -Allow $Permission | Out-Null                \n                    Write-Output \"ACL Allow admin set: $Permission\"\n                }\n            }\n                \n            #denies\n            if ($MSMQPermAdminDeny)\n            {\n                $arrPermissions = $MSMQPermAdminDeny.split(\";\")\n                foreach ($Permission in $arrPermissions)     \n                {\n                    $thisQueue | Set-MsmqQueueAcl -UserName $User -Deny $Permission | Out-Null\n                    Write-Output \"ACL Deny admin set: $Permission\"\n                }\n            }\n        }\n    }\n}",
    "Octopus.Action.Script.Syntax": "PowerShell"
  },
  "Parameters": [
    {
      "Id": null,
      "Name": "$MSMQQueues",
      "Label": "Queue names",
      "HelpText": "Queue names, separated by semicolons. Example: _Queue1;Queue2;Queue3_",
      "DefaultValue": "",
      "DisplaySettings": {}
    },
    {
      "Id": null,
      "Name": "$MSMQUsers",
      "Label": "Queue users",
      "HelpText": "Users with access to the queue separated by semicolons. Example: _DOMAIN\\User1;DOMAIN\\User2_",
      "DefaultValue": "",
      "DisplaySettings": {}
    },
    {
      "Id": null,
      "Name": "$MSMQPermAllow",
      "Label": "Allowed permissions",
      "HelpText": "Permissions granted to the queue users, separated by semicolons. Example: _DeleteMessage;PeekMessage;ReceiveMessage_",
      "DefaultValue": "DeleteMessage;PeekMessage;ReceiveMessage;WriteMessage",
      "DisplaySettings": {}
    },
    {
      "Id": null,
      "Name": "$MSMQPermDeny",
      "Label": "Denied permissions",
      "HelpText": "Denied permissions, separated by semicolons: _TakeQueueOwnership_",
      "DefaultValue": "TakeQueueOwnership",
      "DisplaySettings": {}
    },
    {
      "Id": null,
      "Name": "MSMQAdminUsers",
      "Label": "Admin queue users",
      "HelpText": "Users with access to the queue separated by semicolons. Example: _DOMAIN\\User1;DOMAIN\\User2_",
      "DefaultValue": null,
      "DisplaySettings": {}
    },
    {
      "Id": null,
      "Name": "MSMQPermAdminAllow",
      "Label": "Allowed admin permissions",
      "HelpText": "Permissions granted to the queue admin users, separated by semicolons. Example: _DeleteMessage;PeekMessage;ReceiveMessage_",
      "DefaultValue": "FullControl",
      "DisplaySettings": {}
    },
    {
      "Id": null,
      "Name": "MSMQPermAdminDeny",
      "Label": "Denied admin permissions",
      "HelpText": "Denied permissions, separated by semicolons: _TakeQueueOwnership_",
      "DefaultValue": null,
      "DisplaySettings": {}
    }
  ],
  "LogoAttachmentKey": "CommunityActionTemplates-103",
  "LogoAttachmentMimeType": "image/png"
}